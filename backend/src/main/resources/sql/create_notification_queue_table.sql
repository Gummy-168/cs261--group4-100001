-- ============================================
-- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á notification_queue
-- ============================================
-- ‚ö†Ô∏è ‡∏£‡∏±‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô SQL Server Management Studio

USE EventDB;
GO

PRINT 'Creating table: notification_queue';
GO

-- ‡∏•‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
IF OBJECT_ID('dbo.notification_queue', 'U') IS NOT NULL
    DROP TABLE dbo.notification_queue;
GO

-- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á notification_queue
CREATE TABLE dbo.notification_queue (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL,                    -- ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    event_id BIGINT NOT NULL,                   -- ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
    send_at DATETIME2 NOT NULL,                 -- ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    status NVARCHAR(20) NOT NULL DEFAULT 'PENDING', -- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: PENDING, SENT, FAILED
    created_at DATETIME2 DEFAULT GETDATE(),     -- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    updated_at DATETIME2 DEFAULT GETDATE(),     -- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    
    -- Foreign Keys
    CONSTRAINT FK_notification_queue_user FOREIGN KEY (user_id) 
        REFERENCES dbo.users(id) ON DELETE CASCADE,
    CONSTRAINT FK_notification_queue_event FOREIGN KEY (event_id) 
        REFERENCES dbo.events(id) ON DELETE CASCADE
);
GO

-- ‡∏™‡∏£‡πâ‡∏≤‡∏á Index ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
CREATE INDEX idx_notification_queue_user_id ON dbo.notification_queue(user_id);
CREATE INDEX idx_notification_queue_event_id ON dbo.notification_queue(event_id);
CREATE INDEX idx_notification_queue_status ON dbo.notification_queue(status);
CREATE INDEX idx_notification_queue_send_at ON dbo.notification_queue(send_at);
CREATE INDEX idx_notification_queue_user_event ON dbo.notification_queue(user_id, event_id);
GO

-- ‡∏™‡∏£‡πâ‡∏≤‡∏á Trigger ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó updated_at ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
CREATE TRIGGER trg_notification_queue_updated_at
ON dbo.notification_queue
AFTER UPDATE
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE dbo.notification_queue
    SET updated_at = GETDATE()
    FROM dbo.notification_queue nq
    INNER JOIN inserted i ON nq.id = i.id;
END;
GO

PRINT '‚úÖ Table notification_queue created successfully!';
GO

-- ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
PRINT '';
PRINT '================================================';
PRINT 'üìã ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á notification_queue';
PRINT '================================================';

SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    CHARACTER_MAXIMUM_LENGTH,
    IS_NULLABLE,
    COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'notification_queue'
ORDER BY ORDINAL_POSITION;

PRINT '';
PRINT '================================================';
PRINT '‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!';
PRINT '================================================';
PRINT '';
PRINT '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:';
PRINT '  1. Restart Backend Spring Boot';
PRINT '  2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à';
PRINT '================================================';
GO
